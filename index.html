<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="./logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./logo.png">
    <link rel="manifest" href="./logo.png">
    <title>Ficha Nightfall RPG</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #3a0d0d;
            color: #fff1e6;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #5c1a1a;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
            border: 2px solid #ffd700;
        }

        .header {
            background: linear-gradient(45deg, #5a0000, #8d0000);
            color: #ffd700;
            padding: 15px;
            text-align: center;
            border-bottom: 3px solid #ffd700;
            text-shadow: 2px 2px 2px rgba(0,0,0,0.5);
        }

        .header h1 {
            margin: 0;
            font-size: 1.8em;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .identity-stripe {
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                #ffd700 10px,
                #ffd700 20px
            );
            height: 5px;
            margin-top: 10px;
        }

        .section {
            padding: 15px;
            border-bottom: 1px solid #3a0d0d;
        }

        .photo-section {
            position: relative;
            text-align: center;
            padding: 20px;
        }

        .photo-frame {
            width: 200px;
            height: 250px;
            border: 3px solid #ffd700;
            background: #2a0a0a;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5em;
            color: #ffd700;
            border-radius: 5px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            line-height: 1;
        }

        .grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .field-group label {
            display: block;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #3a0d0d;
            border-radius: 4px;
            margin-bottom: 10px;
            background: #2a0a0a;
            color: #fff1e6;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #ffd700;
            box-shadow: 0 0 5px #ffd700;
            outline: none;
        }

        .security-stripes {
            background: repeating-linear-gradient(
                -45deg,
                #ffd70033,
                #ffd70033 5px,
                transparent 5px,
                transparent 10px
            );
            height: 30px;
            margin: 10px 0;
        }

        .watermark {
            position: absolute;
            opacity: 0.08;
            font-size: 120px;
            transform: rotate(-45deg);
            pointer-events: none;
            color: #ffd700;
            top: 30%;
            left: -50px;
            white-space: nowrap;
        }

        .d20-button {
            position: relative;
            width: 180px;
            height: 120px;
            background: linear-gradient(45deg, #5a0000, #8d0000);
            border: 4px solid #ffd700;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 
                0 0 20px rgba(255,215,0,0.3),
                inset 0 0 15px rgba(0,0,0,0.7);
            overflow: hidden;
        }

        .d20-button::after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                90deg,
                transparent 0%,
                transparent 5%,
                rgba(255,215,0,0.1) 5%,
                rgba(255,215,0,0.1) 10%
            );
            animation: scan 4s linear infinite;
        }

        .d20-button span {
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 60px;
            background: linear-gradient(45deg, #6b6b6b, #3a3a3a);
            border: 3px solid #ffd700;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .d20-button span::before {
            content: "";
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 50px;
            background: linear-gradient(45deg, #4a4a4a, #2a2a2a);
            border-radius: 4px;
        }

        .d20-button:hover span {
            transform: translateY(-50%) rotate(-10deg);
            right: -28px;
        }

        .d20-button:active span {
            transform: translateY(-30%) rotate(5deg);
        }

        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .vida-container {
            padding: 15px;
            background: #2a0a0a;
            border-radius: 8px;
            margin: 10px 0;
        }

        .barra-vida {
            height: 25px;
            background: #4a0000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 2px solid #ffd700;
        }

        .vida-atual {
            height: 100%;
            background: linear-gradient(45deg, #ff0000, #cc0000);
            width: 100%;
            transition: width 0.3s ease;
        }

        .vida-texto {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }

        .controles-vida {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .controles-vida input {
            background: #3a0d0d;
            text-align: center;
            width: 90%;
        }

        .botao-salvar {
            background: #ffd700;
            color: #5a0000;
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }

        .botao-salvar:hover {
            background: #ffdf40;
        }

        .container-atributo {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .btn-atributo {
            background: #ffd700;
            color: #5a0000;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-atributo:hover {
            background: #ffdf40;
            transform: scale(1.1);
        }

        .btn-atributo.plus::after {
            content: "+";
        }

        .btn-atributo.minus::after {
            content: "-";
        }

        .input-atributo {
            flex: 1;
            margin-bottom: 0 !important;
            text-align: center;
        }

        .mensagem-salvo {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ffd700;
            color: #5a0000;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0;
            animation: aparecer 2s ease-in-out;
            z-index: 1000;
        }

        @keyframes aparecer {
            0% { opacity: 0; transform: translateX(-50%) translateY(100%); }
            20% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(100%); }
        }

        .equipamentos-section {
            padding: 15px;
        }

        .equipamento-item {
            background: #2a0a0a;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ffd70033;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }

        .equipamento-dano {
            color: #ffd700;
            font-weight: bold;
        }

        h3 {
            color: #ffd700;
            border-left: 3px solid #ffd700;
            padding-left: 10px;
            margin-top: 0;
        }

        /* Novos estilos para a animação do dado */
        .d20-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Courier New', monospace;
            font-size: 3.5em;
            color: #ffd700;
            text-shadow: 0 0 15px #ffd700;
            opacity: 0.9;
            z-index: 2;
            width: 100%;
            text-align: center;
        }

        .rolling {
            animation: rollNumbers 0.5s steps(1) infinite;
        }

        .critical {
            animation: pulse 0.3s infinite, glow-gold 0.5s infinite;
        }

        .failure {
            animation: pulse 0.3s infinite, glow-red 0.5s infinite;
        }

        @keyframes rollNumbers {
            0% { content: "1"; }
            10% { content: "2"; }
            20% { content: "3"; }
            30% { content: "4"; }
            40% { content: "5"; }
            50% { content: "6"; }
            60% { content: "7"; }
            70% { content: "8"; }
            80% { content: "9"; }
            90% { content: "10"; }
            100% { content: "20"; }
        }

        @keyframes glow-gold {
            0% { text-shadow: 0 0 5px #ffd700; }
            50% { text-shadow: 0 0 20px #ffd700, 0 0 30px #ffd700; }
            100% { text-shadow: 0 0 5px #ffd700; }
        }

        @keyframes glow-red {
            0% { text-shadow: 0 0 5px #ff0000; }
            50% { text-shadow: 0 0 20px #ff0000, 0 0 30px #ff0000; }
            100% { text-shadow: 0 0 5px #ff0000; }
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .escudo-container {
            padding: 15px;
            background: #2a0a0a;
            border-radius: 8px;
            margin: 10px 0;
        }

        .barra-escudo {
            height: 25px;
            background: #4a0000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 2px solid #ffd700;
        }

        .escudo-atual {
            background-color: #00008b;
            height: 100%;
            width: 100%;
            transition: width 0.3s;
            border-radius: 5px 0 0 5px;
        }

        .escudo-texto {
            position: absolute;
            width: 100%;
            text-align: center;
            color: white;
            font-weight: bold;
            top: 0;
            line-height: 25px;
        }

        .controles-escudo{
            display: grid;
            grid-template-columns: 5fr 5fr;
            gap: 10px;
            margin-top: 10px;
        }

        .controles-escudo input {
            background: #3a0d0d;
            text-align: center;
            width: 90%;
    
        }
        #classe{
            text-align: center;
        }
        .level-circle {
        position: absolute;
        bottom: -20px;
        left: 50%;
        transform: translateX(-50%);
        width: 50px;
        height: 50px;
        border: 3px solid #ffd700;
        border-radius: 50%;
        background: #5c1a1a;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        font-weight: bold;
        color: #ffd700;
        text-shadow: 1px 1px 2px #000;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }

    .xp-container {
        margin-top: 35px;
        padding: 0 20px;
        
    }

    .xp-bar {
        height: 15px;
        background: #2a0a0a;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        border: 1px solid #ffd700;
    }

    .xp-fill {
        height: 100%;
        background: linear-gradient(45deg, #00ff00, #008800);
        width: 0%;
        transition: width 0.3s ease;
    }

    .xp-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 0.7em;
        text-shadow: 1px 1px 2px black;
        white-space: nowrap;
    }
    .container-XP {
        display: flex;
        gap: 5px;
        align-items: center;
        margin-top: 10px;
        width: 100%;
        max-width: 220px; /* Ajuste conforme necessário */
        margin-left: auto;
        margin-right: auto;
        text-align: center;
    }

    .btn-XP {
        background: #ffd700;
        color: #5a0000;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        font-weight: bold;
        transition: 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-XP:hover {
        background: #ffdf40;
        transform: scale(1.1);
    }

    .btn-XP.plus::after {
        content: "+";
    }

    .btn-XP.minus::after {
        content: "-";
    }

    #XP {
        width: 80px;
        text-align: center;
        margin: 0 5px;
    }

    </style>
</head>
<body>
    <div class="container">
        <div class="watermark">NIGHTFALL</div>
        
        <div class="header">
            <h1>Cartão de Identificação Nightfall</h1>
            <div class="identity-stripe"></div>
        </div>

        <div class="photo-section">
            <div class="photo-frame">🖼️</div>
            <div class="level-circle" id="level-circle">1</div>
        </div>
        <div class="xp-container">
            <div class="xp-bar">
                <div class="xp-fill" id="xp-fill"></div>
                <div class="xp-text" id="xp-text">0/1000</div>
            </div>
            <div class="field-group">
                <div class="container-XP">
                    <label>XP</label>
                    <button class="btn-XP minus"></button>
                    <input type="number" id="XP" value="0" min="0">
                    <button class="btn-XP plus"></button>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="grid-2col">
                <div class="field-group">
                    <label>Nome Completo</label>
                    <input type="text" id="nome" placeholder="Ex: Kael Faradays">
                </div>
                <div class="field-group">
                    <label>Classe</label>
                    <select id="classe">
                        <option value="humano">Humano</option>
                        <option value="lobisomem">Lobisomem</option>
                        <option value="vampiro">Vampiro</option>
                        <option value="backup">Backup</option>
                        <option value="mago">Mago</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="subclasse-container" class="section" style="display: none;">
            <div class="field-group">
                <label>Subclasse</label>
                <select id="subclasse"></select>
            </div>
        </div>

        <div class="security-stripes"></div>

        <div class="section">
            <h3>Atributos</h3>
            <div class="grid-2col">
                <div class="field-group">
                    <label>Força</label>
                    <div class="container-atributo">
                        <button class="btn-atributo minus"></button>
                        <input type="number" id="FOR" class="input-atributo">
                        <button class="btn-atributo plus"></button>
                    </div>
                </div>
                <div class="field-group">
                    <label>Agilidade</label>
                    <div class="container-atributo">
                        <button class="btn-atributo minus"></button>
                        <input type="number" id="AGI" class="input-atributo">
                        <button class="btn-atributo plus"></button>
                    </div>
                </div>
                <div class="field-group">
                    <label>Inteligência</label>
                    <div class="container-atributo">
                        <button class="btn-atributo minus"></button>
                        <input type="number" id="INT" class="input-atributo">
                        <button class="btn-atributo plus"></button>
                    </div>
                </div>
                <div class="field-group">
                    <label>Carisma</label>
                    <div class="container-atributo">
                        <button class="btn-atributo minus"></button>
                        <input type="number" id="CAR" class="input-atributo">
                        <button class="btn-atributo plus"></button>
                    </div>
                </div>
                <div class="field-group">
                    <label>Precisão</label>
                    <div class="container-atributo">
                        <button class="btn-atributo minus"></button>
                        <input type="number" id="PRE" class="input-atributo">
                        <button class="btn-atributo plus"></button>
                    </div>
                </div>
                <div class="field-group">
                    <label>Resistência</label>
                    <div class="container-atributo">
                        <button class="btn-atributo minus"></button>
                        <input type="number" id="RES" class="input-atributo">
                        <button class="btn-atributo plus"></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="equipamentos-section">
            <h3>Equipamentos</h3>
            <div id="equipamentos-lista">
                <!-- Equipamentos serão inseridos aqui via JavaScript -->
            </div>
        </div>

        <div class="section">
            <h3>Dados Complementares</h3>
            <div class="field-group">
                <label>Habilidades/Fraquezas</label>
                <textarea id="habilidades" rows="3" readonly></textarea>
            </div>
            <div class="field-group">
                <label>História e Motivação</label>
                <textarea id="historia" rows="4" placeholder="Relate sua jornada até aqui..."></textarea>
            </div>
        </div>

        <div class="section">
            <h3>Vitalidade</h3>
            <div class="escudo-container">
                <h3>🛡</h3>
                <div class="barra-escudo">
                    <div class="escudo-atual" id="escudo-barra"></div>
                    <div class="escudo-texto" id="escudo-texto">100/100</div>
                </div>
                <div class="controles-escudo">
                    <input type="number" id="Shield-max" value="100" min="0" placeholder="Escudo Máxima">
                    <input type="number" id="escudo-atual" value="100" min="0" placeholder="Escudo Atual">
                </div>
            </div>
            <div class="vida-container">
                <h3>❤</h3>
                <div class="barra-vida">
                    <div class="vida-atual" id="vida-barra"></div>
                    <div class="vida-texto" id="vida-texto">100/100</div>
                </div>
                <div class="controles-vida">
                    <input type="number" id="vida-max" value="100" min="0" placeholder="Vida Máxima">
                    <input type="number" id="vida-atual" value="100" min="0" placeholder="Vida Atual">
                </div>
            </div>
        </div>

        <div class="section" style="text-align: center;">
            <button class="botao-salvar" onclick="salvarDados()">💾 Salvar Progresso</button>
        </div>

        <div class="security-stripes"></div>

        <div class="section" style="text-align: center; padding: 20px;">
            <button class="d20-button" id="d20-button" onclick="rolarD20()">
                <div class="d20-display" id="d20-display">20</div>
                <span></span>
            </button>
            <div id="resultado-dado" style="margin-top: 15px; color: #ffd700; font-weight: bold;"></div>
        </div>
    </div>

    <script>
        // Banco de dados das classes
        const classes = {
            humano: {
                emoji: '🙎🏽‍♂️',
                subclasses: ['Jacobins', 'Caipora', 'Pitstop'],
                atributos: { FOR: 7, AGI: 8, INT: 6, CAR: 8, PRE: 7, RES: 7 },
                habilidades: {
                    Jacobins: 'Golpes de sacrifício, Aura de fervor\nFraqueza: Fanatismo (-2 em furtividade/diplomacia)',
                    Caipora: 'Combate à distância, Explosivos improvisados\nFraqueza: Dependência de munição',
                    Pitstop: 'Criar/consertar veículos\nFraqueza: Ineficiente sem peças'
                },
                equipamentos: {
                    Jacobins: [
                        "Espada Revolucionária (1d8)",
                        "Armadura de Retalhos",
                        "Bandana da Resistência"
                    ],
                    Pitstop: [
                        "Chave de Grifo Pesado (1d6)",
                        "Macacão Térmico",
                        "Kit de Ferramentas"
                    ],
                    Caipora: [
                        "Arco Composto (1d8)",
                        "Flechas Explosivas",
                        "Botas de Camuflagem"
                    ]
                }
            },
            vampiro: {
                emoji: '🧛',
                atributos: { FOR: 8, AGI: 7, INT: 8, CAR: 9, PRE: 7, RES: 8 },
                habilidades: 'Regeneração, Força, Controle mental\nFraqueza: Luz solar, Prata',
                equipamentos: [
                    "Lâmina Sanguinária (2d4+1)",
                    "Manto das Sombras", 
                    "Anel de Regeneração Noturna"
                ]
            },
            lobisomem: {
                emoji: '🐺',
                atributos: { FOR: 10, AGI: 9, INT: 5, CAR: 6, PRE: 6, RES: 9 },
                habilidades: 'Força brutal, Sentidos aguçados\nFraqueza: Prata, Aconito',
                equipamentos: [
                    "Garras Afiadas (2d6)",
                    "Pele de Lobo Alfa", 
                    "Amuleto Lunar"
                ]
            },
            backup: {
                emoji: '🤖',
                atributos: { FOR: 5, AGI: 7, INT: 10, CAR: 7, PRE: 9, RES: 6 },
                habilidades: 'Hackear dispositivos\nFraqueza: Vulnerável a PEM',
                equipamentos: [
                    "Tablet Hacker MK3",
                    "Pistola Eletromagnética (1d6)",
                    "Colete à Prova de Balas"
                ]
            },
            mago: {
                emoji: '🧙',
                subclasses: ['Rio', 'Mar', 'Verdes', 'Brancos', 'Terra', 'Vermelhos'],
                atributos: { FOR: 4, AGI: 6, INT: 10, CAR: 8, PRE: 6, RES: 6 },
                habilidades: {
                    Rio: 'Manipulação água doce\nFraqueza: Ambientes secos',
                    Mar: 'Controle de marés\nFraqueza: Longe do mar',
                    Verdes: 'Cura e plantas\nFraqueza: Áreas urbanas',
                    Brancos: 'Tempestades\nFraqueza: Locais fechados',
                    Terra: 'Formas animais\nFraqueza: Lentidão',
                    Vermelhos: 'Fogo e magma\nFraqueza: Instabilidade emocional'
                }, 
                equipamentos: {
                    Rio: ["Cajado das Marés", "Anel de Água Pura", "Manto Fluido"],
                    Mar: ["Tridente de Netuno", "Concha Resonante", "Brânquias Místicas"],
                    Verdes: ["Semente da Vida", "Raízes Entrelaçadas", "Pólen Curativo"],
                    Brancos: ["Cetro de Trovão", "Botas Aladas", "Olho do Furacão"],
                    Terra: ["Martelo Telúrico", "Armadura de Quartzo", "Garras de Obsidiana"],
                    Vermelhos: ["Lâmina de Magma", "Coroa de Cinzas", "Orbe Ígneo"]
                }
            }
        };

        // Elementos DOM
        const xpInput = document.getElementById('XP');
        const btnXpPlus = document.querySelector('.btn-XP.plus');
        const btnXpMinus = document.querySelector('.btn-XP.minus')
        const levelCircle = document.getElementById('level-circle');
        const xpFill = document.getElementById('xp-fill');
        const xpText = document.getElementById('xp-text');
        const classeSelect = document.getElementById('classe');
        const subclasseDiv = document.getElementById('subclasse-container');
        const subclasseSelect = document.getElementById('subclasse');
        const equipamentosLista = document.getElementById('equipamentos-lista');
        const fotoFrame = document.querySelector('.photo-frame');
        const atributos = {
            FOR: document.getElementById('FOR'),
            AGI: document.getElementById('AGI'),
            INT: document.getElementById('INT'),
            CAR: document.getElementById('CAR'),
            PRE: document.getElementById('PRE'),
            RES: document.getElementById('RES')
        };
        const habilidadesTextarea = document.getElementById('habilidades');
        const vidaMaxInput = document.getElementById('vida-max');
        const vidaAtualInput = document.getElementById('vida-atual');
        const vidaBarra = document.getElementById('vida-barra');
        const vidaTexto = document.getElementById('vida-texto');
        const d20Button = document.getElementById('d20-button');
        const d20Display = document.getElementById('d20-display');
        const resultadoDado = document.getElementById('resultado-dado');
        const escudoMaxInput   = document.getElementById('Shield-max');
        const escudoAtualInput = document.getElementById('escudo-atual')

        // Atualizar equipamentos baseado na classe/subclasse
        function atualizarEquipamentos() {
            const classe = classeSelect.value;
            const dadosClasse = classes[classe];
            
            let equipamentos = [];
            
            if (dadosClasse.subclasses && subclasseSelect.value) {
                // Classe com subclasses (Humano ou Mago)
                equipamentos = dadosClasse.equipamentos[subclasseSelect.value] || [];
            } else if (Array.isArray(dadosClasse.equipamentos)) {
                // Classe sem subclasses e equipamentos é array
                equipamentos = dadosClasse.equipamentos;
            }
            
            // Limpar lista
            equipamentosLista.innerHTML = '';
            
            // Adicionar novos equipamentos
            equipamentos.forEach(equip => {
                const [nome, dano] = equip.split('(');
                const div = document.createElement('div');
                div.className = 'equipamento-item';
                
                div.innerHTML = `
                    <span>${nome.trim()}</span>
                    ${dano ? `<span class="equipamento-dano">${dano.replace(')', '')}</span>` : ''}
                `;

                equipamentosLista.appendChild(div);
            });
        }

        // Atualizar classe quando selecionada
        function atualizarClasse() {
            const classe = classeSelect.value;
            const dadosClasse = classes[classe];
            
            // Atualizar emoji
            fotoFrame.textContent = dadosClasse.emoji;
            
            // Atualizar subclasses se existirem
            if (dadosClasse.subclasses) {
                subclasseDiv.style.display = 'block';
                subclasseSelect.innerHTML = dadosClasse.subclasses
                    .map(sc => `<option>${sc}</option>`).join('');
                
                // Selecionar primeira subclasse por padrão
                subclasseSelect.value = dadosClasse.subclasses[0];
            } else {
                subclasseDiv.style.display = 'none';
            }
            
            // Atualizar atributos mínimos
            Object.entries(dadosClasse.atributos).forEach(([atributo, valor]) => {
                const input = atributos[atributo];
                input.min = valor;
                if (parseInt(input.value) < valor || isNaN(parseInt(input.value))) {
                    input.value = valor;
                }
            });
            
            // Atualizar habilidades
            if (typeof dadosClasse.habilidades === 'string') {
                habilidadesTextarea.value = dadosClasse.habilidades;
            } else if (subclasseSelect.value) {
                habilidadesTextarea.value = dadosClasse.habilidades[subclasseSelect.value] || '';
            }
            
            // Atualizar equipamentos
            atualizarEquipamentos();
            
            // Salvar automaticamente
            salvarDados();
        }

        function configurarBotoesXP() {
            btnXpPlus.addEventListener('click', () => {
                xpInput.value = parseInt(xpInput.value) + 50;
                atualizarNivelXP();
            });

            btnXpMinus.addEventListener('click', () => {
                const newValue = Math.max(parseInt(xpInput.value) - 50, 0);
                xpInput.value = newValue;
                atualizarNivelXP();
            });
        }

        function atualizarNivelXP() {
            const xp = parseInt(xpInput.value) || 0;
            const nivel = Math.floor(xp / 1000) + 1;
            const xpProximoNivel = xp % 1000;
            
            document.getElementById('level-circle').textContent = nivel;
            document.getElementById('xp-fill').style.width = `${(xpProximoNivel / 1000) * 100}%`;
            document.getElementById('xp-text').textContent = `${xpProximoNivel}/1000 XP`;
            
            salvarDados();
        }

        // Atualizar barra de vida
        function atualizarVida() {
            const max = parseInt(vidaMaxInput.value) || 0;
            const atual = parseInt(vidaAtualInput.value) || 0;
            const percentual = Math.min(100, (atual / max) * 100);
            
            vidaBarra.style.width = `${percentual}%`;
            vidaTexto.textContent = `${atual}/${max}`;
            salvarDados();
        }
        function atualizarEscudo() {
            const escudoMaxInput = document.getElementById('Shield-max');
            const escudoAtualInput = document.getElementById('escudo-atual');
            const escudoBarra = document.getElementById('escudo-barra');
            const escudoTexto = document.getElementById('escudo-texto');

            let escudoMax = parseInt(escudoMaxInput.value) || 0;
            let escudoAtual = parseInt(escudoAtualInput.value) || 0;

            // Corrige se escudoAtual for maior que o máximo
            if (escudoAtual > escudoMax) {
                escudoAtual = escudoMax;
                escudoAtualInput.value = escudoMax;
            }

            const largura = escudoMax > 0 ? (escudoAtual / escudoMax) * 100 : 0;
            escudoBarra.style.width = `${largura}%`;
            escudoTexto.textContent = `${escudoAtual}/${escudoMax}`;
        }


        // Aplicar dano baseado no resultado do dado
        function aplicarDano(resultado) {
            const RES = parseInt(document.getElementById('RES').value) || 0;
            const escudoMax = parseInt(document.getElementById('Shield-max').value) || 0;
            const escudoAtualInput = document.getElementById('escudo-atual');
            const vidaAtualInput = document.getElementById('vida-atual');
            const vidaMax = parseInt(document.getElementById('vida-max').value) || 100;

            let escudoAtual = parseInt(escudoAtualInput.value) || 0;
            let vidaAtual = parseInt(vidaAtualInput.value) || 0;

            let danoBase = 0;

            if (resultado === 1) {
                danoBase = Math.floor((vidaAtual + escudoAtual) / 2); // metade da vida+escudo atual
            } else if (resultado < 15) {
                danoBase = 5;
            } else {
                // resultado >= 15: cura escudo ou vida
                if (resultado === 20) {
                    escudoAtual = escudoMax;
                    vidaAtual = Math.min(vidaAtual + 10, vidaMax);
                } 

                // Atualiza UI e sai da função
                escudoAtualInput.value = escudoAtual;
                vidaAtualInput.value = vidaAtual;
                atualizarEscudo();
                atualizarVida();
                
                const resultadoDiv = document.getElementById('resultado-dado');
                resultadoDiv.innerHTML += `
                    <div style="color: #00bfff; margin-top: 5px; border-top: 1px solid #00bfff33; padding-top: 5px;">
                         ${resultado === 20 ? 'TOTALMENTE RESTAURADO' : ''}${resultado === 20 ? ' + VIDA +10' : ''}
                    </div>
                `;
                return;
            }

            // Aplica o dano no escudo primeiro 
            const reducao = 1 - (RES / 100);
            const danoReduzido = Math.floor(danoBase * (1 - RES / 100));
            if (escudoAtual > 0) {
                if (danoBase <= escudoAtual) {
                    escudoAtual -= danoReduzido;
                    danoBase = 0;
                } else {
                    danoBase -= danoReduzido;
                    escudoAtual = 0;
                }
            }

            // Aplica o restante do dano na vida
            if (danoBase > 0) {
                vidaAtual = Math.max(vidaAtual - danoBase, 0);
            }

            escudoAtualInput.value = escudoAtual;
            vidaAtualInput.value = vidaAtual;
            atualizarEscudo();
            atualizarVida();

            const resultadoDiv = document.getElementById('resultado-dado');
            resultadoDiv.innerHTML += `
                <div style="color: #ffd700; margin-top: 5px; border-top: 1px solid #ffd70033; padding-top: 5px;">
                    DANO APLICADO: ${danoBase} | ESCUDO: ${escudoAtual} | VIDA: ${vidaAtual}
                </div>
            `;

            if (vidaAtual === 0) {
                alert('💀 Você morreu!');
            }
        }


        // Salvar dados no localStorage
        function salvarDados() {
            const dados = {
                nome: document.getElementById('nome').value,
                classe: classeSelect.value,
                subclasse: subclasseSelect.value,
                atributos: {
                    FOR: atributos.FOR.value,
                    AGI: atributos.AGI.value,
                    INT: atributos.INT.value,
                    CAR: atributos.CAR.value,
                    PRE: atributos.PRE.value,
                    RES: atributos.RES.value
                },
                habilidades: habilidadesTextarea.value,
                historia: document.getElementById('historia').value,
                vidaMax: vidaMaxInput.value,
                vidaAtual: vidaAtualInput.value,
                escudoMax: escudoMaxInput.value,
                escudoAtual: escudoAtualInput.value,
                xp: xpInput.value,
                nivel: document.getElementById('level-circle').textContent
            };
            
            localStorage.setItem('fichaNightfall', JSON.stringify(dados));
            
            // Mostrar mensagem de salvamento
            const mensagem = document.createElement('div');
            mensagem.className = 'mensagem-salvo';
            mensagem.textContent = 'Progresso salvo com sucesso! ✅';
            document.body.appendChild(mensagem);
            
            setTimeout(() => {
                mensagem.remove();
            }, 2000);
        }

        // Carregar dados do localStorage
        function carregarDados() {
            const dados = JSON.parse(localStorage.getItem('fichaNightfall'));
            const escudoMaxInput = document.getElementById('Shield-max');
            const escudoAtualInput = document.getElementById('escudo-atual');
            const xpInput = document.getElementById('XP');
            const levelCircle = document.getElementById('level-circle');

            if (dados) {
                document.getElementById('nome').value = dados.nome || '';
                classeSelect.value = dados.classe || 'humano';
                document.getElementById('historia').value = dados.historia || '';

                // NOVO: Carregar XP imediatamente
                if (dados.xp) {
                    xpInput.value = dados.xp;
                }
                
                // Dar tempo para atualizar a classe antes de carregar subclasse
                setTimeout(() => {
                    if (dados.subclasse) {
                        subclasseSelect.value = dados.subclasse;
                    }
                    
                    habilidadesTextarea.value = dados.habilidades || '';
                    
                    // Atualizar atributos
                    Object.entries(dados.atributos || {}).forEach(([atributo, valor]) => {
                        if (atributos[atributo]) {
                            atributos[atributo].value = valor;
                        }
                    });
                    
                    // Atualizar vida
                    vidaMaxInput.value = dados.vidaMax || 100;
                    vidaAtualInput.value = dados.vidaAtual || 100;
                    atualizarVida();

                    // Atualizar escudo 
                    escudoMaxInput.value = dados.escudoMax || 0;
                    escudoAtualInput.value = dados.escudoAtual || 0;
                    atualizarEscudo();

                    // NOVO: Atualizar nível e XP após carregar tudo
                    atualizarNivelXP();
 

                    
                    // Atualizar equipamentos após tudo estar carregado
                    atualizarEquipamentos();
                }, 100);
                
                // Atualizar classe principal
                atualizarClasse();

                // NOVO: Carregar nível diretamente se existir
                if (dados.nivel) {
                    levelCircle.textContent = dados.nivel;
                }
            } else {
                // Inicializar com valores padrão
                classeSelect.value = 'humano';
                atualizarClasse();

                 // NOVO: Inicializar XP/nível padrão
                xpInput.value = 0;
                atualizarNivelXP();
            }

            // NOVO: Garantir atualização mesmo sem dados salvos
            atualizarNivelXP();
        }

        // Rolar dado D20 com animação
        function rolarD20() {
            
            // Desativar botão durante a animação
            d20Button.disabled = true;
            
            // Iniciar animação de rolagem
            d20Display.textContent = '';
            d20Display.classList.add('rolling');
            
            // Rolagem mais longa para crítico/falha
            const isCriticalOrFailure = Math.random() < 0.1; // 10% de chance
            const duration = isCriticalOrFailure ? 2000 : 1000;
            
            setTimeout(() => {
                // Gerar resultado
                const resultado = Math.floor(Math.random() * 20) + 1;
                
                // Parar animação e mostrar resultado
                d20Display.classList.remove('rolling');
                d20Display.textContent = resultado;
                
                // Efeitos especiais para crítico/falha
                if (resultado === 20) {
                    d20Display.classList.add('critical');
                    resultadoDado.innerHTML = '<div style="font-size: 1.2em;">CRÍTICO LEGENDÁRIO!</div>';
                } else if (resultado === 1) {
                    d20Display.classList.add('failure');
                    resultadoDado.innerHTML = '<div style="font-size: 1.2em;">FALHA CATASTRÓFICA!</div>';
                } else {
                    resultadoDado.innerHTML = `<div style="font-size: 1.2em;">Resultado: ${resultado}</div>`;
                }
                
                // Aplicar dano
                aplicarDano(resultado);
                
                // Reativar botão após 1 segundo
                setTimeout(() => {
                    d20Button.disabled = false;
                    d20Display.classList.remove('critical', 'failure');
                }, 1000);
                
            }, duration);
        }

        // Configurar botões de atributo
        function configurarBotoesAtributo() {
            document.querySelectorAll('.container-atributo').forEach(container => {
                const input = container.querySelector('input');
                const btnPlus = container.querySelector('.plus');
                const btnMinus = container.querySelector('.minus');

                btnPlus.addEventListener('click', () => {
                    input.value = parseInt(input.value || input.min) + 1;
                    input.dispatchEvent(new Event('input'));
                });

                btnMinus.addEventListener('click', () => {
                    const currentValue = parseInt(input.value || input.min);
                    if (currentValue > parseInt(input.min)) {
                        input.value = currentValue - 1;
                        input.dispatchEvent(new Event('input'));
                    }
                });
            });
        }

        // Event Listeners
        classeSelect.addEventListener('change', atualizarClasse);
        
        subclasseSelect.addEventListener('change', () => {
            const classe = classeSelect.value;
            const dadosClasse = classes[classe];
            
            if (typeof dadosClasse.habilidades === 'object') {
                habilidadesTextarea.value = dadosClasse.habilidades[subclasseSelect.value] || '';
            }
            
            atualizarEquipamentos();
            salvarDados();
        });

        vidaMaxInput.addEventListener('input', atualizarVida);
        vidaAtualInput.addEventListener('input', atualizarVida);
        document.getElementById('Shield-max').addEventListener('input', atualizarEscudo);
        document.getElementById('escudo-atual').addEventListener('input', atualizarEscudo);
        xpInput.addEventListener('input', atualizarNivelXP);

        
        // Validar valores mínimos nos inputs numéricos
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', function() {
                if (this.value < parseInt(this.min)) {
                    this.value = this.min;
                }
                salvarDados();
            });
        });

        // Inicialização
        window.addEventListener('load', () => {
            configurarBotoesAtributo();
            configurarBotoesXP(); 
            carregarDados();
        });
    </script>
</body>
</html>
